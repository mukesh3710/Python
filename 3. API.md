

# ⭐ MODULE 3 — CALLING THE SERVICENOW API (BEGINNER → REAL WORLD)

We will learn:

1. What is a REST API
2. How ServiceNow exposes CMDB data
3. Python library needed (`requests`)
4. Building the ServiceNow URL with filters
5. Sending GET requests
6. Authentication (basic + token)
7. Handling errors correctly
8. Parsing the returned JSON
9. Returning the final list of host records

---

# ⭐ STEP 1 — Understanding a REST API

A REST API is simply a URL you call to get data.

Example (fake):

```
https://mycompany.service-now.com/api/now/table/cmdb_ci_server?sysparm_limit=10
```

This gives JSON output.

---

# ⭐ STEP 2 — Install Python module `requests`

You need the `requests` library:

```bash
pip install requests
```

Import it in Python:

```python
import requests
```

---

# ⭐ STEP 3 — Basic ServiceNow GET request

### Minimal Python GET:

```python
import requests

url = "https://yourinstance.service-now.com/api/now/table/cmdb_ci_server"

response = requests.get(url, auth=('username', 'password'))
print(response.json())
```

This is the basic foundation.

---

# ⭐ STEP 4 — Build correct ServiceNow query for your use case

You provided:

✔ install_status = 1
✔ state = Live
✔ OS filter = Red Hat
✔ Max hosts returned = 15000
✔ Fields to return:

```
name,fadn,os,os_version_used_for,u_wave
```

✔ Query parameters sample:

```
assignment_group=343dsfd
managed_by=3g454g
hardware_status=installed
nameSTARTSWITHabc^ORnameSTARTSWITHdef
```

ServiceNow wants them formatted like:

```
sysparm_query=assignment_group=343dsfd^hardware_status=installed^install_status=1^state=Live
```

---

# ⭐ STEP 5 — Build query in Python (Important)

```python
sn_query = (
    "install_status=1^"
    "state=Live^"
    "osLIKELinux%20Red%20Hat^"
    "hardware_status=installed"
)
```

Add extra filters dynamically later (you will do this in Module 4).

---

# ⭐ STEP 6 — Full URL construction

```python
base = "https://yourinstance.service-now.com"
table = "/api/now/table/cmdb_ci_server"

params = {
    "sysparm_display_value": "true",
    "sysparm_fields": "name,fadn,os,os_version_used_for,u_wave,u_patch_slot,u_patching_group",
    "sysparm_query": sn_query,
    "sysparm_limit": 15000
}

url = base + table
```

---

# ⭐ STEP 7 — Sending GET request with parameters

```python
response = requests.get(url, params=params, auth=(user, pw))
```

You can check the final URL:

```python
print(response.url)
```

---

# ⭐ STEP 8 — Handling errors properly (IMPORTANT for production scripts)

```python
if response.status_code != 200:
    print(f"ERROR: ServiceNow API failed {response.status_code}", file=sys.stderr)
    sys.exit(1)
```

---

# ⭐ STEP 9 — Parse JSON

```python
snow_json = response.json()
records = snow_json.get("result", [])
```

Loop through records:

```python
for r in records:
    print(r["name"], r["u_patching_group"])
```

---

# ⭐ STEP 10 — Return the records as a Python list

You need this for further processing:

```python
def query_servicenow(user, pw, instance_url):
    import requests, sys

    base_url = f"https://{instance_url}/api/now/table/cmdb_ci_server"

    params = {
        "sysparm_display_value": "true",
        "sysparm_fields": "name,fadn,os,os_version_used_for,u_wave,u_patch_slot,u_patching_group",
        "sysparm_query": (
            "install_status=1^"
            "state=Live^"
            "hardware_status=installed^"
            "osLIKELinux%20Red%20Hat"
        ),
        "sysparm_limit": 15000
    }

    try:
        response = requests.get(base_url, params=params, auth=(user, pw))
    except Exception as e:
        print(f"ERROR: Cannot connect to ServiceNow: {e}", file=sys.stderr)
        sys.exit(1)

    if response.status_code != 200:
        print(f"ERROR: ServiceNow returned {response.status_code}", file=sys.stderr)
        print(response.text, file=sys.stderr)
        sys.exit(1)

    data = response.json()
    return data.get("result", [])
```

---

# ⭐ STEP 11 — Example usage

```python
records = query_servicenow("api_user", "SecretPass123", "myinstance.service-now.com")

for host in records:
    print(host["name"], host["u_patching_group"])
```

---

# ⭐ STEP 12 — Real Dynamic Inventory Integration

Later your `main()` will call:

```python
records = query_servicenow(args.username, args.password, args.instance)
```

Then:

* filter hosts
* DNS validation
* parse groups
* distribute into waves
* output final JSON inventory

---

# ⭐ Module 3 Summary

You now learned:

✔ How to use the `requests` library
✔ How ServiceNow API URL works
✔ How query strings work (sysparm_query)
✔ How to supply parameters (sysparm_fields, limit, display=True)
✔ How to authenticate
✔ How to handle API errors
✔ How to parse ServiceNow JSON into Python dicts
✔ How to return clean data for next modules

You now have the **ServiceNow data extraction backbone** for your dynamic inventory script.

